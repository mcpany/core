# Copyright 2026 Author(s) of MCP Any
# SPDX-License-Identifier: Apache-2.0

name: Manage PRs (Merge & Cleanup)

on:
  schedule:
    - cron: '0 */10 * * *' # Runs every 10 minutes
  workflow_dispatch: # Allows manual triggering

jobs:
  manage-prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # Step 1: Merge PRs that are passing and ready
      - name: Merge Passing PRs
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          # Find PRs that are open, passing CI, and have no merge conflicts
          gh pr list \
            --repo mcpany/core \
            --base main \
            --search "is:pr is:open status:success author:@me" \
            --json number \
            --jq '.[].number' | \
          while read pr_number; do
            echo "Merging PR #$pr_number..."
            gh pr merge $pr_number --squash --repo mcpany/core
          done

      # Step 2: Close PRs that have merge conflicts
      - name: Close Conflicting PRs
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          # Find PRs that are open but have merge conflicts
          gh pr list \
            --repo mcpany/core \
            --base main \
            --search "is:open mergeable:conflicting" \
            --json number \
            --jq '.[].number' | \
          while read pr_number; do
            echo "Closing conflicting PR #$pr_number..."

            # Add a comment first explaining why
            gh pr comment $pr_number \
              --repo mcpany/core \
              --body "ðŸ¤– **Automated Cleanup:** This PR has merge conflicts. Please resolve them locally and reopen or open a new PR."

            # Close the PR
            gh pr close $pr_number --repo mcpany/core
          done
