# Copyright 2026 Author(s) of MCP Any
# SPDX-License-Identifier: Apache-2.0

name: Manage PRs (Merge & Cleanup)

on:
  schedule:
    - cron: '*/10 * * * *' # Runs every 10 minutes
  workflow_dispatch: # Allows manual triggering

jobs:
  manage-prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # Step 1: Merge PRs that are passing and ready
      - name: Merge Passing PRs
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          # Find PRs that are open, passing CI, and have no merge conflicts
          gh pr list \
            --repo mcpany/core \
            --base main \
            --search "is:pr is:open status:success author:@me" \
            --json number \
            --jq '.[].number' | \
          while read pr_number; do
            echo "Processing PR #$pr_number..."

            # Retry mechanism
            max_retries=3
            retry_count=0
            success=false

            while [ $retry_count -lt $max_retries ]; do
              if gh pr merge $pr_number --squash --repo mcpany/core; then
                success=true
                echo "Successfully merged PR #$pr_number"
                break
              else
                echo "Failed to merge PR #$pr_number (Attempt $((retry_count+1))/$max_retries)"
                retry_count=$((retry_count+1))
                sleep 5 # Wait a bit before retrying
              fi
            done

            if [ "$success" = false ]; then
              echo "Could not merge PR #$pr_number after $max_retries attempts. Closing it."
              gh pr comment $pr_number --repo mcpany/core --body "ðŸ¤– **Automated Cleanup:** This PR has merge conflicts. Please resolve them locally and reopen or open a new PR."
              gh pr close $pr_number --repo mcpany/core
            fi
          done
