# Copyright 2025 Author(s) of MCP Any
# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'
      - 'LICENSE'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.filter.outputs.src }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - '**'
              - '!**.md'
              - '!**.txt'
              - '!docs/**'
              - '!LICENSE'

  lint:
    needs: changes
    if: ${{ needs.changes.outputs.src == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r server/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/tests/integration/upstream/package-lock.json

      # Cache Tools (protoc, helm, etc.)
      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: build/env/bin
          key: ${{ runner.os }}-build-env-bin-${{ hashFiles('Makefile', 'server/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-env-bin-

      # Cache Lint (golangci-lint, pre-commit)
      - name: Cache Lint
        uses: actions/cache@v4
        with:
          path: build/.cache
          key: ${{ runner.os }}-lint-cache-${{ hashFiles('server/go.sum', 'server/.pre-commit-config.yaml') }}
          restore-keys: |
            ${{ runner.os }}-lint-cache-

      - name: Install Make
        run: sudo apt-get update && sudo apt-get install -y make

      - name: Prepare environment
        run: make prepare

      - name: Lint
        run: make lint


  unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-images]
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      IPINFO_API_TOKEN: ${{ secrets.IPINFO_API_TOKEN }}
    steps:
      # - name: Free Disk Space (Ubuntu)
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     tool-cache: false
      #     android: true
      #     dotnet: true
      #     haskell: true
      #     large-packages: true
      #     docker-images: true
      #     swap-storage: true

      - uses: actions/checkout@v4

      - name: Configure Docker Registry Mirrors
        run: |
          # Configure multiple mirrors in array format
          # Docker will try mirror.gcr.io first.
          echo '{"registry-mirrors": ["https://mirror.gcr.io"]}' | sudo tee /etc/docker/daemon.json

          sudo systemctl restart docker
          docker info # Verify the mirrors are listed

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r server/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/tests/integration/upstream/package-lock.json

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Date
        id: get-date
        run: |
          echo "week=$(/bin/date -u "+%V")" >> $GITHUB_OUTPUT
        shell: bash

      - name: Docker Cache
        uses: actions/cache@v4
        with:
          path: build/buildx-cache
          key: ${{ runner.os }}-buildx-${{ steps.get-date.outputs.week }}-${{ hashFiles('tests/integration/examples/Dockerfile.timeserver', 'tests/integration/examples/timeserver_patch/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ steps.get-date.outputs.week }}-${{ hashFiles('tests/integration/examples/Dockerfile.timeserver', 'tests/integration/examples/timeserver_patch/**') }}-
            ${{ runner.os }}-buildx-${{ steps.get-date.outputs.week }}-

      - name: Cache Docker images
        uses: ScribeMD/docker-cache@0.5.0
        with:
          key: docker-images-${{ runner.os }}-${{ steps.get-date.outputs.week }}

      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: build/env/bin
          key: ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}-
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-

      - name: Prepare environment
        run: make prepare CACHE_TO=type=local,dest=build/buildx-cache CACHE_FROM=type=local,src=build/buildx-cache

      - name: Test (Short)
        run: |
          make test-fast CACHE_TO=type=local,dest=build/buildx-cache CACHE_FROM=type=local,src=build/buildx-cache COVERAGE_FILE=coverage-fast.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: false
          files: coverage-fast.out
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

  e2e-parallel:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-images]
    strategy:
      fail-fast: false
      matrix:
        shard: [1/2, 2/2]
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      IPINFO_API_TOKEN: ${{ secrets.IPINFO_API_TOKEN }}
    steps:
      # - name: Free Disk Space (Ubuntu)
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     tool-cache: false
      #     android: true
      #     dotnet: true
      #     haskell: true
      #     large-packages: true
      #     docker-images: true
      #     swap-storage: true

      - uses: actions/checkout@v4

      - name: Configure Docker Registry Mirrors
        run: |
          # Configure multiple mirrors in array format
          # Docker will try mirror.gcr.io first.
          echo '{"registry-mirrors": ["https://mirror.gcr.io"]}' | sudo tee /etc/docker/daemon.json

          sudo systemctl restart docker
          docker info # Verify the mirrors are listed

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r server/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/tests/integration/upstream/package-lock.json

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Date
        id: get-date
        run: |
          echo "week=$(/bin/date -u "+%V")" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: build/env/bin
          key: ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}-
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-

      - name: Download Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-server

      - name: Download HTTP Echo Image
        uses: actions/download-artifact@v4
        with:
          name: image-http-echo

      - name: Download Time Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-time-server

      - name: Download Cowsay Image
        uses: actions/download-artifact@v4
        with:
          name: image-cowsay

      - name: Download Everything Image
        uses: actions/download-artifact@v4
        with:
          name: image-everything

      - name: Load Docker Images
        run: |
          for f in *.tar; do
            docker load -i "$f"
          done

      - name: Prepare environment
        run: make prepare

      - name: run parallel e2e
        run: |
          make e2e-parallel SHARD=${{ matrix.shard }} SKIP_DOCKER_REBUILD=true CACHE_TO=type=gha,mode=max CACHE_FROM=type=gha COVERAGE_FILE=coverage-e2e-parallel.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: false
          files: coverage-e2e-parallel.out
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

  build-images:
    name: Build Docker Images
    needs: changes
    if: ${{ needs.changes.outputs.src == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r server/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/tests/integration/upstream/package-lock.json

      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: build/env/bin
          key: ${{ runner.os }}-build-env-bin-${{ hashFiles('Makefile', 'server/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-env-bin-

      - name: Prepare environment
        run: make prepare

      - name: Generate Protos
        run: make gen

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and Save Images
        run: |
          # Server
          make -C server build-docker CACHE_TO=type=gha,mode=max,scope=server CACHE_FROM=type=gha,scope=server
          docker save -o server.tar mcpany/server:latest

          # HTTP Echo
          make -C server build-http-echo-docker CACHE_TO=type=gha,mode=max,scope=http-echo CACHE_FROM=type=gha,scope=http-echo
          docker save -o http-echo.tar mcpany/http-echo-server:latest

          # Time Server
          make -C server build-e2e-timeserver-docker CACHE_TO=type=gha,mode=max,scope=time-server CACHE_FROM=type=gha,scope=time-server
          docker save -o time-server.tar mcpany-e2e-time-server

          # Cowsay
          make -C server build-cowsay-docker CACHE_TO=type=gha,mode=max,scope=cowsay CACHE_FROM=type=gha,scope=cowsay
          docker save -o cowsay.tar mcpany/e2e-cowsay-server:latest

          # Everything
          make -C server build-everything-docker CACHE_TO=type=gha,mode=max,scope=everything CACHE_FROM=type=gha,scope=everything
          docker save -o everything.tar mcpany/everything:latest

          # UI
          make -C server docker-build-ui CACHE_TO=type=gha,mode=max,scope=ui CACHE_FROM=type=gha,scope=ui
          docker save -o ui.tar mcpany/ui:latest

          # Operator
          make -C server docker-build-operator CACHE_TO=type=gha,mode=max,scope=operator CACHE_FROM=type=gha,scope=operator
          docker save -o operator.tar mcpany/operator:latest

          # UI Test Image
          make -C ui build-test-docker CACHE_TO=type=gha,mode=max,scope=ui-test CACHE_FROM=type=gha,scope=ui-test
          docker save -o ui-test-image.tar mcpany-ui-e2e:latest

      - name: Upload Server Image
        uses: actions/upload-artifact@v4
        with:
          name: image-server
          path: server.tar
          retention-days: 1

      - name: Upload HTTP Echo Image
        uses: actions/upload-artifact@v4
        with:
          name: image-http-echo
          path: http-echo.tar
          retention-days: 1

      - name: Upload Time Server Image
        uses: actions/upload-artifact@v4
        with:
          name: image-time-server
          path: time-server.tar
          retention-days: 1

      - name: Upload Cowsay Image
        uses: actions/upload-artifact@v4
        with:
          name: image-cowsay
          path: cowsay.tar
          retention-days: 1

      - name: Upload Everything Image
        uses: actions/upload-artifact@v4
        with:
          name: image-everything
          path: everything.tar
          retention-days: 1

      - name: Upload UI Image
        uses: actions/upload-artifact@v4
        with:
          name: image-ui
          path: ui.tar
          retention-days: 1

      - name: Upload Operator Image
        uses: actions/upload-artifact@v4
        with:
          name: image-operator
          path: operator.tar
          retention-days: 1

      - name: Upload UI Test Image
        uses: actions/upload-artifact@v4
        with:
          name: image-ui-test
          path: ui-test-image.tar
          retention-days: 1

  e2e-sequential:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [build-images]
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      IPINFO_API_TOKEN: ${{ secrets.IPINFO_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Docker Registry Mirrors
        run: |
          echo '{"registry-mirrors": ["https://mirror.gcr.io"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          docker info

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r server/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/tests/integration/upstream/package-lock.json

      - name: Download Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-server

      - name: Download HTTP Echo Image
        uses: actions/download-artifact@v4
        with:
          name: image-http-echo

      - name: Download Time Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-time-server

      - name: Download Cowsay Image
        uses: actions/download-artifact@v4
        with:
          name: image-cowsay

      - name: Download Everything Image
        uses: actions/download-artifact@v4
        with:
          name: image-everything

      - name: Load Docker Images
        run: |
          for f in *.tar; do
            docker load -i "$f"
          done
      - name: Get Date
        id: get-date
        run: |
          echo "week=$(/bin/date -u "+%V")" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: build/env/bin
          key: ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}-
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-

      - name: Prepare environment
        run: make prepare

      - name: run sequential e2e
        run: |
          make e2e-sequential SKIP_DOCKER_REBUILD=true CACHE_TO=type=gha,mode=max CACHE_FROM=type=gha COVERAGE_FILE=coverage-e2e-sequential.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: false
          files: coverage-e2e-sequential.out
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

  e2e-public-api:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-images]
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      IPINFO_API_TOKEN: ${{ secrets.IPINFO_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Docker Registry Mirrors
        run: |
          # Configure multiple mirrors in array format
          # Docker will try mirror.gcr.io first.
          echo '{"registry-mirrors": ["https://mirror.gcr.io"]}' | sudo tee /etc/docker/daemon.json

          sudo systemctl restart docker
          docker info # Verify the mirrors are listed

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r server/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/tests/integration/upstream/package-lock.json

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Date
        id: get-date
        run: |
          echo "week=$(/bin/date -u "+%V")" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Tools
        uses: actions/cache@v4
        with:
          path: build/env/bin
          key: ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-${{ hashFiles('Makefile') }}-
            ${{ runner.os }}-build-env-bin-${{ steps.get-date.outputs.week }}-

      - name: Prepare environment
        run: make prepare

      - name: test public api
        run: |
          make test-public-api CACHE_TO=type=gha,mode=max CACHE_FROM=type=gha COVERAGE_FILE=coverage-public-api.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: false
          files: coverage-public-api.out
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

  docker-smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-images]
    steps:
      - uses: actions/checkout@v4

      - name: Configure Docker Registry Mirrors
        run: |
          # Configure multiple mirrors in array format
          # Docker will try mirror.gcr.io first.
          echo '{"registry-mirrors": ["https://mirror.gcr.io"]}' | sudo tee /etc/docker/daemon.json

          sudo systemctl restart docker
          docker info # Verify the mirrors are listed

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-server

      - name: Load Docker Image
        run: |
          docker load -i server.tar

      - name: Smoke Test
        run: |
          chmod +x server/tests/smoke_test.sh
          ./server/tests/smoke_test.sh mcpany/server:latest

  ui-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-images]
    strategy:
      fail-fast: false
      matrix:
        shard: [1/2, 2/2]
    steps:
      #      - name: Free Disk Space (Ubuntu)
      #        uses: jlumbroso/free-disk-space@main
      #        with:
      #          tool-cache: false
      #          android: true
      #          dotnet: true
      #          haskell: true
      #          large-packages: true
      #          docker-images: false
      #          swap-storage: true
      #
      - uses: actions/checkout@v4

      - name: Download Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-server

      - name: Download UI Test Image
        uses: actions/download-artifact@v4
        with:
          name: image-ui-test

      - name: Download HTTP Echo Image
        uses: actions/download-artifact@v4
        with:
          name: image-http-echo

      - name: Load Docker Images
        run: |
          for f in *.tar; do
            docker load -i "$f"
          done

      - name: Test UI
        run: |
          SERVER_IMAGE=mcpany/server:latest make -C ui test-ci PLAYWRIGHT_ARGS="--shard=${{ matrix.shard }}"

  k8s-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-images]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Install UI Dependencies
        run: |
          cd ui
          npm install
          npx playwright install chromium

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: mcp-e2e
          wait: 120s

      - name: Download Server Image
        uses: actions/download-artifact@v4
        with:
          name: image-server

      - name: Download Operator Image
        uses: actions/download-artifact@v4
        with:
          name: image-operator

      - name: Download UI Image
        uses: actions/download-artifact@v4
        with:
          name: image-ui

      - name: Load Docker Images into Kind
        run: |
          # Load all tarballs into docker daemon first?
          # kind load docker-image requires image in docker daemon or archive.
          # kind load image-archive might be better but let's stick to docker daemon for consistency
          for f in *.tar; do
            docker load -i "$f"
          done

          # Now load specific images into Kind
          kind load docker-image mcpany/server:latest --name mcp-e2e
          kind load docker-image mcpany/operator:latest --name mcp-e2e
          kind load docker-image mcpany/ui:latest --name mcp-e2e

      - name: Load Docker Images already loaded above
        run: |
          echo "Images already loaded in previous step."

      - name: Run K8s E2E Tests
        run: |
          make k8s-e2e SKIP_IMAGE_BUILD=true IMAGE_TAG=latest

  ci-success:
    runs-on: ubuntu-latest
    needs:
      [
        lint,
        build-images,
        unit-test,
        e2e-sequential,
        e2e-parallel,
        e2e-public-api,
        docker-smoke-test,
        ui-test,
        k8s-e2e,
      ]
    if: always()
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Auto-Squash
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}" || echo "Failed to enable auto-merge (check permissions/settings)"

      - name: Check Results and Comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            // 1. Check for Failures
            const needs = ${{ toJson(needs) }};
            const failedJobNames = Object.keys(needs).filter(key => needs[key].result === 'failure' || needs[key].result === 'cancelled');
            const { owner, repo } = context.repo;
            const run_id = context.runId;
            const run_url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;
            const pull_number = context.issue.number;

            if (failedJobNames.length === 0) {
              console.log('All required jobs passed successfully (or were skipped).');
              return;
            }

            // 2. Prepare Comment Logic (only if PR)
            if (pull_number) {
              let failuresDetails = [];
              try {
                // We use github.rest instead of github.actions for v7 compat if needed, but octokit is global
                // List jobs to find step failures
                const jobsResponse = await github.rest.actions.listJobsForWorkflowRun({
                  owner,
                  repo,
                  run_id,
                });
                const failedJobs = jobsResponse.data.jobs.filter(job => job.conclusion === 'failure');

                for (const job of failedJobs) {
                   const failedSteps = job.steps
                     .filter(step => step.conclusion === 'failure')
                     .map(step => step.name)
                     .join(', ');
                   const msg = failedSteps ? `${job.name}: Failed at step(s) "${failedSteps}"` : `${job.name}: Failed`;
                   failuresDetails.push(msg);
                }
              } catch (e) {
                console.log('Error fetching job details:', e);
                failuresDetails = failedJobNames.map(name => `${name}: Failed`);
              }

              const list = failuresDetails.map(detail => `- **${detail}**`).join('\n');
              const agentPrompt = `
              Please investigate the failures above.
              1. Check the [Action logs](${run_url}) for the specific error messages (e.g., failed tests, lint errors, build issues).
              2. Analyze the root cause.
              3. Apply fixes to the codebase.
              `;

              const body = `‚ùå **CI Checks Failed**

              The following GitHub Actions checks failed in this run:
              ${list}

              ---
              ${agentPrompt}
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body
              });
            } else {
              console.log('Not a PR, skipping failure comment.');
            }

            // 3. Fail the workflow
            const msg = 'The following required jobs did not pass: ' + failedJobNames.join(', ');
            core.setFailed(msg);
