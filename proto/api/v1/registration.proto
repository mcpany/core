// Copyright 2025 Author(s) of MCP Any
// SPDX-License-Identifier: Apache-2.0

edition = "2023";

package mcpany.api.v1;

import "google/api/annotations.proto";
import "proto/config/v1/upstream_service.proto";
import "proto/config/v1/resource.proto";
import "proto/config/v1/tool.proto";
import "google/protobuf/go_features.proto";

// option features.(pb.go).api_level = API_OPAQUE;


option go_package = "github.com/mcpany/core/proto/api/v1";
option java_outer_classname = "RegistrationProto";
option features.field_presence = IMPLICIT;

// RegisterServiceRequest represents a request to register a new upstream service.
message RegisterServiceRequest {
    // The configuration of the upstream service to register.
    mcpany.config.v1.UpstreamServiceConfig config = 1;
}

// RegisterServiceResponse represents the response after registering a service.
message RegisterServiceResponse {
    // A status message indicating success or failure details (e.g., "Service registered successfully").
    string message = 1;
    // A list of tools discovered during the registration process.
    repeated mcpany.config.v1.ToolDefinition discovered_tools = 2;
    // The generated unique key for the registered service.
    string service_key = 3;
    // A list of resources discovered during the registration process.
    repeated mcpany.config.v1.ResourceDefinition discovered_resources = 4;
}

// ValidateServiceRequest represents a request to validate a service configuration without registering it.
message ValidateServiceRequest {
    // The configuration of the upstream service to validate.
    mcpany.config.v1.UpstreamServiceConfig config = 1;
}

// ValidateServiceResponse represents the result of a service validation request.
message ValidateServiceResponse {
    // Indicates whether the service configuration is valid.
    bool valid = 1;
    // A message describing the validation result or error details.
    string message = 2;
    // A list of tools that would be discovered if registered.
    repeated mcpany.config.v1.ToolDefinition discovered_tools = 3;
    // A list of resources that would be discovered if registered.
    repeated mcpany.config.v1.ResourceDefinition discovered_resources = 4;
}

// RegistrationService provides methods to register, validate, and manage upstream services.
service RegistrationService {
    // RegisterService registers a new upstream service with the MCP Any server.
    //
    // It accepts a service configuration, validates it, and if successful, adds the service
    // to the registry. It returns the discovered tools and resources.
    rpc RegisterService(RegisterServiceRequest) returns (RegisterServiceResponse) {
        option (google.api.http) = {
            post: "/v1/services/register"
            body: "*"
        };
    }
    // ValidateService validates a service configuration without registering it.
    //
    // This is useful for "dry-run" scenarios where a client wants to check if a configuration
    // is valid and what tools/resources it would expose.
    rpc ValidateService(ValidateServiceRequest) returns (ValidateServiceResponse) {
        option (google.api.http) = {
            post: "/v1/services/validate"
            body: "*"
        };
    }
    // UnregisterService removes an existing upstream service from the registry.
    //
    // It stops any active connections or workers associated with the service.
    rpc UnregisterService(UnregisterServiceRequest) returns (UnregisterServiceResponse) {
        option (google.api.http) = {
            post: "/v1/services/unregister"
            body: "*"
        };
    }
    // InitiateOAuth2Flow starts an OAuth2 authentication flow for a specific service.
    //
    // It generates the authorization URL that the client should visit to authenticate.
    rpc InitiateOAuth2Flow(InitiateOAuth2FlowRequest) returns (InitiateOAuth2FlowResponse) {
        option (google.api.http) = {
            post: "/v1/services/oauth2/initiate"
            body: "*"
        };
    }
    // RegisterTools manually registers a list of tools for a service.
    //
    // This can be used to add tools that were not automatically discovered.
    rpc RegisterTools(RegisterToolsRequest) returns (RegisterToolsResponse) {
        option (google.api.http) = {
            post: "/v1/services/tools/register"
            body: "*"
        };
    }
    // GetServiceStatus retrieves the status and metrics of a registered service.
    rpc GetServiceStatus(GetServiceStatusRequest) returns (GetServiceStatusResponse) {
        option (google.api.http) = {
            get: "/v1/services/{service_name}/status"
        };
    }
    // ListServices returns a list of all registered upstream services.
    rpc ListServices(ListServicesRequest) returns (ListServicesResponse) {
        option (google.api.http) = {
            get: "/v1/services"
        };
    }
    // GetService retrieves the configuration of a specific registered service.
    rpc GetService(GetServiceRequest) returns (GetServiceResponse) {
        option (google.api.http) = {
            get: "/v1/services/{service_name}"
        };
    }
}

// ListServicesRequest represents a request to list all registered services.
message ListServicesRequest {}

// ListServicesResponse contains the list of registered services.
message ListServicesResponse {
    // The list of registered upstream service configurations.
    repeated mcpany.config.v1.UpstreamServiceConfig services = 1;
}

// InitiateOAuth2FlowRequest represents a request to start an OAuth2 flow.
message InitiateOAuth2FlowRequest {
  // The ID of the service to authenticate with.
  string service_id = 1;
  // The namespace of the service.
  string namespace = 2;
  // The ID of the credential to use or create.
  string credential_id = 3;
  // The URL to redirect to after successful authentication.
  string redirect_url = 4;
}

// InitiateOAuth2FlowResponse contains the information needed to proceed with OAuth2.
message InitiateOAuth2FlowResponse {
  // The URL the user should visit to authorize access.
  string authorization_url = 1;
  // The state parameter used for CSRF protection.
  string state = 2;
}

// UnregisterServiceRequest represents a request to unregister a service.
message UnregisterServiceRequest {
  // The user-defined unique ID (name) of the service to deregister.
  string service_name = 1;
  // The namespace of the service (optional).
  string namespace = 2;
}

// UnregisterServiceResponse represents the response after unregistering a service.
message UnregisterServiceResponse {
  // A message indicating success or details about the operation.
  string message = 1;
}

// RegisterToolsRequest represents a request to manually register tools for a service.
message RegisterToolsRequest {
    // The name of the service to register tools for.
    string service_name = 1;
    // The namespace of the service.
    string namespace = 2;
    // The list of tool definitions to register.
    repeated mcpany.config.v1.ToolDefinition tools = 3;
}

// RegisterToolsResponse represents the response after registering tools.
message RegisterToolsResponse {
    // A message indicating success.
    string message = 1;
    // The number of tools that were successfully registered.
    int32 tools_registered = 2;
}

// GetServiceRequest represents a request to retrieve a service configuration.
message GetServiceRequest {
    // The name of the service to retrieve.
    string service_name = 1;
}

// GetServiceResponse contains the requested service configuration.
message GetServiceResponse {
    // The configuration of the requested service.
    mcpany.config.v1.UpstreamServiceConfig service = 1;
}

// GetServiceStatusRequest represents a request to retrieve service status.
message GetServiceStatusRequest {
    // The name of the service.
    string service_name = 1;
    // The namespace of the service.
    string namespace = 2;
}

// GetServiceStatusResponse contains the status and metrics of a service.
message GetServiceStatusResponse {
    // The list of tools currently available for this service.
    repeated mcpany.config.v1.ToolDefinition tools = 1;
    // Key-value pairs of metrics for the service (e.g., "uptime", "requests").
    map<string, int64> metrics = 2;
}
