// Copyright (C) 2025 Author(s) of MCP Any
// SPDX-License-Identifier: Apache-2.0

edition = "2023";

package mcpany.config.v1;

import "google/protobuf/duration.proto";
import "proto/bus/bus.proto";
import "proto/config/v1/resource.proto";
import "proto/config/v1/call.proto";
import "proto/config/v1/auth.proto";

option go_package = "github.com/mcpany/core/proto/config/v1";

// ===================================================================
// Root Server Configuration
// ===================================================================

// McpAnyServerConfig is the root configuration for the entire MCPANY server.
message McpAnyServerConfig {
  // Server-wide operational parameters.
  GlobalSettings global_settings = 1;
  // A list of all configured upstream services that MCP Any can proxy to.
  repeated UpstreamServiceConfig upstream_services = 2;
  // A list of upstream service collections to load from.
  repeated UpstreamServiceCollection upstream_service_collections = 3;
}

// UpstreamServiceCollection defines a collection of upstream services that can be loaded from a remote source.
message UpstreamServiceCollection {
  // The name of the collection.
  string name = 1;
  // The HTTP URL to load the collection from.
  string http_url = 2;
  // The priority of the collection. Lower numbers have higher priority.
  int32 priority = 3;
  // The authentication to use when fetching the collection.
  UpstreamAuthentication authentication = 4;
}

// GlobalSettings contains server-wide operational parameters.
message GlobalSettings {
  enum LogLevel {
    INFO = 0;
    WARN = 1;
    ERROR = 2;
    DEBUG = 3;
  }
  // The address and port the server should bind to (e.g., "0.0.0.0:8080").
  string bind_address = 1;
  // The base path for all MCP API endpoints (e.g., "/mcp/v1").
  string mcp_basepath = 2;
  // The logging level for the server.
  LogLevel log_level = 3;
  // The message bus configuration.
  bus.MessageBus message_bus = 4;
}


// ===================================================================
// Upstream Service Definitions
// ===================================================================

// UpstreamServiceConfig is the top-level configuration for a single upstream service
// that mcpany will proxy. It defines the service's identity, how to connect to it,
// and policies like authentication, caching, rate limiting, and load balancing.
message UpstreamServiceConfig {
  // The full SHA256 hash of the service name, used as a unique identifier.
  // This ensures that for the same service name, the ID is always the same.
  string id = 1;
  // The original user-provided name for the upstream service.
  // This name is used for identification, logging, and metrics.
  string name = 2;
  // A sanitized version of the service name, conforming to identifier rules.
  // @inject_tag: yaml:"-"
  //
  // This field is managed internally and should not be set by the user.
  string sanitized_name = 18;
  // Configuration for the pool of connections to the upstream service.
  ConnectionPoolConfig connection_pool = 3;
  // Authentication configuration for mcpany to use when connecting to the upstream service.
  UpstreamAuthentication upstream_authentication = 4;
  // Caching configuration to improve performance and reduce load on the upstream.
  CacheConfig cache = 5;
  // Rate limiting to protect the upstream service from being overwhelmed.
  RateLimitConfig rate_limit = 6;
  // Strategy for distributing requests among multiple instances of the service.
  LoadBalancingStrategy load_balancing_strategy = 7;
  // Advanced resiliency features to handle failures gracefully.
  ResilienceConfig resilience = 8;

  // The specific configuration for the type of upstream service.
  oneof service_config {
    McpUpstreamService mcp_service = 9;
    HttpUpstreamService http_service = 10;
    GrpcUpstreamService grpc_service = 11;
    OpenapiUpstreamService openapi_service = 12;
    CommandLineUpstreamService command_line_service = 13;
    WebsocketUpstreamService websocket_service = 16;
    WebrtcUpstreamService webrtc_service = 17;
  }

  // The version of the upstream service, if known (e.g., "v1.2.3").
  string version = 14;

  // Authentication configuration for securing access to the MCP Any service (incoming requests).
  AuthenticationConfig authentication = 15;

  // If true, this upstream service is disabled.
  bool disable = 19;
  // The priority of the service. Lower numbers have higher priority.
  int32 priority = 20;
}

// --- Upstream Service Types ---

// GrpcUpstreamService defines an upstream service that speaks gRPC.
message GrpcUpstreamService {
  // The address of the gRPC server (e.g., "localhost:50051").
  string address = 1;
  // If true, mcpany will use gRPC reflection to discover services and methods.
  bool use_reflection = 2;
  // TLS configuration for the gRPC connection.
  TLSConfig tls_config = 3;
  // Manually defined mappings from MCP tools to gRPC calls.
  repeated GrpcToolDefinition tools = 4;
  // Health check configuration.
  GrpcHealthCheck health_check = 5;
  // A list of protobuf definitions for the gRPC service.
  repeated ProtoDefinition proto_definitions = 6;
  // A collection of protobuf files to be discovered.
  repeated ProtoCollection proto_collection = 7;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 8;
}

message ProtoDefinition {
  oneof proto_ref {
    ProtoFile proto_file = 1;
    ProtoDescriptor proto_descriptor = 2;
  }
}

message ProtoFile {
  string file_name = 1;
  oneof file_ref {
    string file_content = 2;
    string file_path = 3;
  }
}

message ProtoDescriptor {
  string file_name = 1;
  oneof file_ref {
    string file_path = 2;
  }
}

message ProtoCollection {
  string root_path = 1;
  string path_match_regex = 2;
  bool is_recursive = 3;
}

// HttpUpstreamService defines an upstream service that speaks HTTP.
message HttpUpstreamService {
  // The base URL of the HTTP service (e.g., "https://api.example.com").
  string address = 1;
  // Manually defined mappings from MCP tools to HTTP calls.
  repeated HttpToolDefinition tools = 2;
  // Configuration for checking the health of the HTTP service.
  HttpHealthCheck health_check = 3;
  // TLS configuration for the HTTP connection.
  TLSConfig tls_config = 4;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 5;
}

// WebsocketUpstreamService defines an upstream service that communicates over Websocket.
message WebsocketUpstreamService {
  // The URL of the Websocket service (e.g., "ws://api.example.com/ws").
  string address = 1;
  // Manually defined mappings from MCP tools to websocket calls.
  repeated WebsocketToolDefinition tools = 2;
  // TLS configuration for the Websocket connection.
  TLSConfig tls_config = 3;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 4;
}

// WebrtcUpstreamService defines an upstream service that communicates over WebRTC data channels.
message WebrtcUpstreamService {
  // The URL of the WebRTC signaling service (e.g., "http://api.example.com/signal").
  string address = 1;
  // Manually defined mappings from MCP tools to webrtc calls.
  repeated WebrtcToolDefinition tools = 2;
  // TLS configuration for the signaling connection.
  TLSConfig tls_config = 3;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 4;
}

// OpenapiUpstreamService defines a service based on an OpenAPI/Swagger specification.
message OpenapiUpstreamService {
  // The base URL of the API.
  string address = 1;
  // The OpenAPI specification content (JSON or YAML).
  string openapi_spec = 2;
  // Health check configuration.
  HttpHealthCheck health_check = 3;
  // TLS configuration for the connection.
  TLSConfig tls_config = 4;
  // Optional: Overrides or specific configurations for calls discovered from the spec.
  repeated OpenAPIToolDefinition tools = 5;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 6;
}

// CommandLineUpstreamService defines a service that communicates over standard I/O.
message CommandLineUpstreamService {
  // The command to execute the service.
  string command = 1;
  // The working directory for the command.
  string working_directory = 3;
  // Manually defined mappings from MCP tools to command line commands.
  repeated CommandLineToolDefinition tools = 4;
  // Health check configuration.
  CommandLineHealthCheck health_check = 5;
  // Caching configuration to improve performance and reduce load on the upstream.
  CacheConfig cache = 6;
  // Container environment to run the command in.
  ContainerEnvironment container_environment = 7;
  // Timeout for the command execution.
  google.protobuf.Duration timeout = 8;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 9;
}

// McpUpstreamService defines an upstream that is already an MCP-compliant service.
message McpUpstreamService {
  // The connection details for the upstream MCP service.
  oneof connection_type {
    McpStreamableHttpConnection http_connection = 1;
    // Connect via a stdio process.
    McpStdioConnection stdio_connection = 2;
  }
  // If true, mcpany will automatically discover and proxy all tools from the upstream.
  bool tool_auto_discovery = 3;
  // Optional: Pre-defined tools to register, can be used to filter or augment discovered tools.
  repeated ToolDefinition predefined_tools = 4;
  // Optional: Overrides or specific configurations for calls discovered from the service.
  repeated MCPToolDefinition tools = 6;
  // A list of resources served by this service.
  repeated ResourceDefinition resources = 7;
}

// McpStdioConnection defines the parameters for a stdio-based connection.
message McpStdioConnection {
  // The command and arguments to execute the service.
  string command = 1;
  repeated string args = 2;
  // The working directory for the command.
  string working_directory = 3;
  // Optional: The container image to use. If not provided, an image will be
  // selected based on the command.
  string container_image = 4;
  // Optional: A list of commands to run as setup before the main command.
  repeated string setup_commands = 5;
}

message McpStreamableHttpConnection {
  // Connect via HTTP.
  string http_address = 1;
  // TLS configuration, applicable if using an http_address.
  TLSConfig tls_config = 5;
}


// --- Call & Tool Definitions ---


// --- Service Policies and Configs ---

// ConnectionPoolConfig defines settings for managing a pool of connections to an upstream service.
message ConnectionPoolConfig {
  // The maximum number of simultaneous connections to allow to the upstream service.
  int32 max_connections = 1;
  // The maximum number of idle connections to keep in the pool.
  int32 max_idle_connections = 2;
  // The duration a connection can remain idle in the pool before being closed.
  google.protobuf.Duration idle_timeout = 3;
}

// Defines a health check for an HTTP-based service.
message HttpHealthCheck {
  // The full URL to send the health check request to.
  string url = 1;
  // The expected HTTP status code for a successful health check. Defaults to 200.
  int32 expected_code = 2;
  // Optional: A substring that must be present in the response body for the check to pass.
  string expected_response_body_contains = 3;
  // How often to perform the health check.
  google.protobuf.Duration interval = 4;
  // The timeout for each health check attempt.
  google.protobuf.Duration timeout = 5;
}

// Defines a health check for a gRPC-based service.
message GrpcHealthCheck {
  // The gRPC service name to check (e.g., "grpc.health.v1.Health").
  string service = 1;
  // The gRPC method to call.
  string method = 2;
  // A JSON string representing the request message.
  string request = 3;
  // A JSON string representing the expected response message.
  string expected_response = 4;
  // Set to true if connecting to the gRPC service without TLS.
  bool insecure = 5;
  // How often to perform the health check.
  google.protobuf.Duration interval = 6;
  // The timeout for each health check attempt.
  google.protobuf.Duration timeout = 7;
}

// Defines a health check for a command line-based service.
message CommandLineHealthCheck {
  // The method or command to send to the command line service for the health check.
  string method = 1;
  // The input/prompt to send to the service.
  string prompt = 2;
  // A substring expected in the service's output for the check to pass.
  string expected_response_contains = 3;
  // How often to perform the health check.
  google.protobuf.Duration interval = 4;
  // The timeout for each health check attempt.
  google.protobuf.Duration timeout = 5;
}

// Defines the container environment for running a command.
message ContainerEnvironment {
  // The name of the container.
  string name = 1;
  // The image to use for the container.
  string image = 2;
  // The volumes to mount into the container, with destination as key and source as value.
  map<string, string> volumes = 3;
}

// Defines strategies for load balancing across multiple service endpoints.
enum LoadBalancingStrategy {
  // Distributes requests sequentially among the available servers.
  ROUND_ROBIN = 0;
  // Sends the next request to the server that has the fewest active connections.
  LEAST_CONNECTIONS = 1;
  // Selects a server at random.
  RANDOM = 2;
}

// Configuration for rate limiting requests to the upstream service.
message RateLimitConfig {
  // Whether rate limiting is enabled.
  bool is_enabled = 1;
  // The maximum number of requests allowed per second.
  double requests_per_second = 2;
  // The number of requests that can be allowed in a short burst.
  int64 burst = 3;
}


// Configuration for service resilience features like circuit breakers and retries.
message ResilienceConfig {
  // Circuit breaker configuration to prevent repeated calls to a failing service.
  CircuitBreakerConfig circuit_breaker = 1;
  // Retry policy for failed requests.
  RetryConfig retry_policy = 2;
}

// CircuitBreakerConfig defines the parameters for the circuit breaker pattern.
message CircuitBreakerConfig {
  // If the failure rate exceeds this threshold, the circuit opens. (e.g., 0.5 for 50%)
  double failure_rate_threshold = 1;
  // The number of consecutive failures required to open the circuit.
  int32 consecutive_failures = 2;
  // The duration the circuit remains open before transitioning to half-open.
  google.protobuf.Duration open_duration = 3;
  // The number of requests to allow in the half-open state to test for recovery.
  int32 half_open_requests = 4;
}

// RetryConfig defines the parameters for retrying failed requests.
message RetryConfig {
  // The number of times to retry a failed request.
  int32 number_of_retries = 1;
  // The base duration for the backoff between retries.
  google.protobuf.Duration base_backoff = 2;
  // The maximum duration for the backoff.
  google.protobuf.Duration max_backoff = 3;
}


// TLSConfig defines the TLS settings for connecting to an upstream service.
message TLSConfig {
  // The server name to use for SNI.
  string server_name = 1;
  // Path to the CA certificate file for verifying the server's certificate.
  string ca_cert_path = 2;
  // Path to the client certificate file for mTLS.
  string client_cert_path = 3;
  // Path to the client private key file for mTLS.
  string client_key_path = 4;
  // If true, the client will not verify the server's certificate chain. Use with caution.
  bool insecure_skip_verify = 5;
}
