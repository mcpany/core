/**
 * Copyright 2025 Author(s) of MCP Any
 * SPDX-License-Identifier: Apache-2.0
 */

"use client";

import { useState, useEffect } from "react";
import { ToolDefinition } from "@proto/config/v1/tool";
import { HttpCallDefinition, HttpCallDefinition_HttpMethod, HttpParameterMapping, ParameterType, ParameterSchema } from "@proto/config/v1/call";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Plus, Trash2 } from "lucide-react";

interface HttpToolEditorProps {
    tool: ToolDefinition | null;
    call: HttpCallDefinition | null;
    onSave: (tool: ToolDefinition, call: HttpCallDefinition) => void;
    onCancel: () => void;
}

/**
 * A form component to create or edit an HTTP tool definition.
 * It manages both the high-level ToolDefinition and the low-level HttpCallDefinition.
 *
 * @param props - Component props
 * @param props.tool - The existing tool definition to edit, or null for a new tool.
 * @param props.call - The existing HTTP call definition to edit, or null for a new call.
 * @param props.onSave - Callback fired when the user saves the tool.
 * @param props.onCancel - Callback fired when the user cancels the operation.
 */
export function HttpToolEditor({ tool, call, onSave, onCancel }: HttpToolEditorProps) {
    // Tool State
    const [name, setName] = useState(tool?.name || "");
    const [description, setDescription] = useState(tool?.description || "");

    // Call State
    const [method, setMethod] = useState<HttpCallDefinition_HttpMethod>(call?.method || HttpCallDefinition_HttpMethod.HTTP_METHOD_GET);
    const [path, setPath] = useState(call?.endpointPath || "");
    const [parameters, setParameters] = useState<HttpParameterMapping[]>(call?.parameters || []);

    // Errors
    const [errors, setErrors] = useState<Record<string, string>>({});

    useEffect(() => {
        if (tool) {
            setName(tool.name);
            setDescription(tool.description);
        }
        if (call) {
            setMethod(call.method);
            setPath(call.endpointPath);
            setParameters(call.parameters || []);
        }
    }, [tool, call]);

    const handleSave = () => {
        const newErrors: Record<string, string> = {};
        if (!name) newErrors.name = "Name is required";
        if (!path) newErrors.path = "Path is required";

        if (Object.keys(newErrors).length > 0) {
            setErrors(newErrors);
            return;
        }

        // Generate ID if new
        const callId = call?.id || `call-${crypto.randomUUID()}`;

        const newTool: ToolDefinition = {
            name,
            description,
            callId,
            inputSchema: undefined, // Will be generated by backend or we could generate it here
            serviceId: tool?.serviceId || "", // Will be filled by parent
            isStream: false,
            title: name,
            readOnlyHint: method === HttpCallDefinition_HttpMethod.HTTP_METHOD_GET,
            destructiveHint: method !== HttpCallDefinition_HttpMethod.HTTP_METHOD_GET,
            idempotentHint: method === HttpCallDefinition_HttpMethod.HTTP_METHOD_GET || method === HttpCallDefinition_HttpMethod.HTTP_METHOD_PUT,
            openWorldHint: true,
            disable: false,
            profiles: [],
            mergeStrategy: 0,
            tags: [],
            integrity: undefined,
        };

        const newCall: HttpCallDefinition = {
            id: callId,
            endpointPath: path,
            method,
            parameters,
            inputTransformer: undefined,
            outputTransformer: undefined,
            cache: undefined,
            inputSchema: undefined,
            outputSchema: undefined,
        };

        onSave(newTool, newCall);
    };

    const addParameter = () => {
        setParameters([...parameters, {
            schema: {
                name: `param${parameters.length + 1}`,
                description: "",
                type: ParameterType.STRING,
                isRequired: true,
                defaultValue: undefined
            },
            secret: undefined,
            disableEscape: false
        }]);
    };

    const updateParameter = (index: number, updates: Partial<ParameterSchema>) => {
        const newParams = [...parameters];
        if (newParams[index].schema) {
            newParams[index] = {
                ...newParams[index],
                schema: { ...newParams[index].schema!, ...updates }
            };
            setParameters(newParams);
        }
    };

    const removeParameter = (index: number) => {
        setParameters(parameters.filter((_, i) => i !== index));
    };

    return (
        <div className="space-y-6 p-4 border rounded-md bg-background">
            <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                    <Label htmlFor="tool-name">Tool Name</Label>
                    <Input
                        id="tool-name"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        placeholder="get_users"
                        className={errors.name ? "border-destructive" : ""}
                    />
                    {errors.name && <p className="text-xs text-destructive">{errors.name}</p>}
                </div>
                <div className="space-y-2">
                    <Label htmlFor="tool-desc">Description</Label>
                    <Input
                        id="tool-desc"
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        placeholder="Fetches a list of users"
                    />
                </div>
            </div>

            <div className="grid grid-cols-4 gap-4">
                <div className="col-span-1 space-y-2">
                    <Label htmlFor="http-method">Method</Label>
                    <Select
                        value={method.toString()}
                        onValueChange={(val) => setMethod(parseInt(val))}
                    >
                        <SelectTrigger id="http-method">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value={HttpCallDefinition_HttpMethod.HTTP_METHOD_GET.toString()}>GET</SelectItem>
                            <SelectItem value={HttpCallDefinition_HttpMethod.HTTP_METHOD_POST.toString()}>POST</SelectItem>
                            <SelectItem value={HttpCallDefinition_HttpMethod.HTTP_METHOD_PUT.toString()}>PUT</SelectItem>
                            <SelectItem value={HttpCallDefinition_HttpMethod.HTTP_METHOD_DELETE.toString()}>DELETE</SelectItem>
                            <SelectItem value={HttpCallDefinition_HttpMethod.HTTP_METHOD_PATCH.toString()}>PATCH</SelectItem>
                        </SelectContent>
                    </Select>
                </div>
                <div className="col-span-3 space-y-2">
                    <Label htmlFor="endpoint-path">Endpoint Path</Label>
                    <Input
                        id="endpoint-path"
                        value={path}
                        onChange={(e) => setPath(e.target.value)}
                        placeholder="/users/{id}"
                        className={errors.path ? "border-destructive" : ""}
                    />
                    <p className="text-xs text-muted-foreground">Use <code>{`{paramName}`}</code> for path parameters.</p>
                </div>
            </div>

            <div className="space-y-2">
                <div className="flex items-center justify-between">
                    <Label>Parameters</Label>
                    <Button variant="outline" size="sm" onClick={addParameter}>
                        <Plus className="h-4 w-4 mr-2" /> Add Parameter
                    </Button>
                </div>
                <div className="border rounded-md">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>Name</TableHead>
                                <TableHead>Type</TableHead>
                                <TableHead>Required</TableHead>
                                <TableHead>Description</TableHead>
                                <TableHead className="w-[50px]"></TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {parameters.map((param, index) => (
                                <TableRow key={index}>
                                    <TableCell>
                                        <Input
                                            value={param.schema?.name || ""}
                                            onChange={(e) => updateParameter(index, { name: e.target.value })}
                                            placeholder="id"
                                            className="h-8"
                                        />
                                    </TableCell>
                                    <TableCell>
                                        <Select
                                            value={param.schema?.type.toString()}
                                            onValueChange={(val) => updateParameter(index, { type: parseInt(val) })}
                                        >
                                            <SelectTrigger className="h-8">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value={ParameterType.STRING.toString()}>String</SelectItem>
                                                <SelectItem value={ParameterType.NUMBER.toString()}>Number</SelectItem>
                                                <SelectItem value={ParameterType.INTEGER.toString()}>Integer</SelectItem>
                                                <SelectItem value={ParameterType.BOOLEAN.toString()}>Boolean</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </TableCell>
                                    <TableCell>
                                        <Switch
                                            checked={param.schema?.isRequired}
                                            onCheckedChange={(checked) => updateParameter(index, { isRequired: checked })}
                                        />
                                    </TableCell>
                                    <TableCell>
                                        <Input
                                            value={param.schema?.description || ""}
                                            onChange={(e) => updateParameter(index, { description: e.target.value })}
                                            className="h-8"
                                            placeholder="The user ID"
                                        />
                                    </TableCell>
                                    <TableCell>
                                        <Button variant="ghost" size="icon" onClick={() => removeParameter(index)} className="h-8 w-8 text-destructive">
                                            <Trash2 className="h-4 w-4" />
                                        </Button>
                                    </TableCell>
                                </TableRow>
                            ))}
                            {parameters.length === 0 && (
                                <TableRow>
                                    <TableCell colSpan={5} className="text-center text-muted-foreground h-24">
                                        No parameters defined.
                                    </TableCell>
                                </TableRow>
                            )}
                        </TableBody>
                    </Table>
                </div>
            </div>

            <div className="flex justify-end gap-2 pt-4">
                <Button variant="outline" onClick={onCancel}>Cancel</Button>
                <Button onClick={handleSave}>Save Tool</Button>
            </div>
        </div>
    );
}
