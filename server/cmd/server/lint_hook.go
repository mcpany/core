// Copyright 2025 Author(s) of MCP Any
// SPDX-License-Identifier: Apache-2.0

package main

import (
	"fmt"
	"os"
	"path/filepath"
)

func installGitHook() error {
	if _, err := os.Stat(".git"); os.IsNotExist(err) {
		return fmt.Errorf("not a git repository (no .git directory found)")
	}

	hookDir := filepath.Join(".git", "hooks")
	if err := os.MkdirAll(hookDir, 0755); err != nil {
		return fmt.Errorf("failed to create hooks directory: %w", err)
	}

	hookPath := filepath.Join(hookDir, "pre-commit")
	content := `#!/bin/sh
# Auto-generated by mcpany lint --install-git-hook

# Check if mcpany is installed
if ! command -v mcpany >/dev/null 2>&1; then
    echo "⚠️  mcpany not found in PATH. Skipping lint check."
    exit 0
fi

# Run lint
echo "Running mcpany lint..."
mcpany lint
if [ $? -ne 0 ]; then
    echo "❌ mcpany lint failed. Commit aborted."
    exit 1
fi
`
	if err := os.WriteFile(hookPath, []byte(content), 0755); err != nil {
		return fmt.Errorf("failed to write git hook: %w", err)
	}
	fmt.Printf("✅ Pre-commit hook installed to %s\n", hookPath)
	return nil
}
