=== RUN   TestNewConnectionFactory
--- PASS: TestNewConnectionFactory (0.00s)
=== RUN   TestWithDialer
--- PASS: TestWithDialer (0.00s)
=== RUN   TestNewConnection
--- PASS: TestNewConnection (0.00s)
=== RUN   TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig
=== RUN   TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/nil_fds
=== RUN   TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/bad_file_descriptor_set
=== RUN   TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/call_definition_not_found
time=2025-12-19T16:47:39.715-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:469 msg="Call definition not found for tool" call_id=non-existent-call tool_name=test-tool
=== RUN   TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/successful_tool_registration
--- PASS: TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig (0.01s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/nil_fds (0.00s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/bad_file_descriptor_set (0.00s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/call_definition_not_found (0.01s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCToolsFromConfig/successful_tool_registration (0.00s)
=== RUN   TestGRPCUpstream_createAndRegisterPromptsFromConfig
time=2025-12-19T16:47:39.718-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:549 msg="Registered prompt" prompt_name=test-service.test-prompt is_reload=false
--- PASS: TestGRPCUpstream_createAndRegisterPromptsFromConfig (0.00s)
=== RUN   TestGRPCUpstream_Register_WithProtoContent
time=2025-12-19T16:47:39.719-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=TestMethod3 is_reload=false
time=2025-12-19T16:47:39.719-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=test-service toolsAdded=1
--- PASS: TestGRPCUpstream_Register_WithProtoContent (0.00s)
=== RUN   TestGrpcPool_New
--- PASS: TestGrpcPool_New (0.00s)
=== RUN   TestGrpcPool_New_MtlsFailure
--- PASS: TestGrpcPool_New_MtlsFailure (0.00s)
=== RUN   TestGrpcPool_New_InvalidTarget
--- PASS: TestGrpcPool_New_InvalidTarget (0.00s)
=== RUN   TestGrpcPool_New_NilConfig
--- PASS: TestGrpcPool_New_NilConfig (0.00s)
=== RUN   TestGrpcPool_Get_ContextCancelled
--- PASS: TestGrpcPool_Get_ContextCancelled (0.00s)
=== RUN   TestNewGRPCUpstream
--- PASS: TestNewGRPCUpstream (0.00s)
=== RUN   TestGRPCUpstream_Register
=== RUN   TestGRPCUpstream_Register/nil_service_config
=== RUN   TestGRPCUpstream_Register/invalid_service_name
=== RUN   TestGRPCUpstream_Register/nil_grpc_service_config
=== RUN   TestGRPCUpstream_Register/authenticator_creation_fails
=== RUN   TestGRPCUpstream_Register/reflection_fails
--- PASS: TestGRPCUpstream_Register (10.00s)
    --- PASS: TestGRPCUpstream_Register/nil_service_config (0.00s)
    --- PASS: TestGRPCUpstream_Register/invalid_service_name (0.00s)
    --- PASS: TestGRPCUpstream_Register/nil_grpc_service_config (0.00s)
    --- PASS: TestGRPCUpstream_Register/authenticator_creation_fails (0.00s)
    --- PASS: TestGRPCUpstream_Register/reflection_fails (10.00s)
=== RUN   TestGRPCUpstream_createAndRegisterGRPCTools
=== RUN   TestGRPCUpstream_createAndRegisterGRPCTools/nil_parsed_data
=== RUN   TestGRPCUpstream_createAndRegisterGRPCTools/service_info_not_found
=== RUN   TestGRPCUpstream_createAndRegisterGRPCTools/bad_file_descriptor_set
--- PASS: TestGRPCUpstream_createAndRegisterGRPCTools (0.00s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCTools/nil_parsed_data (0.00s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCTools/service_info_not_found (0.00s)
    --- PASS: TestGRPCUpstream_createAndRegisterGRPCTools/bad_file_descriptor_set (0.00s)
=== RUN   TestGRPCUpstream_Register_WithMockServer
=== RUN   TestGRPCUpstream_Register_WithMockServer/successful_registration_with_reflection_and_cache_hit
time=2025-12-19T16:47:49.726-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.726-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.726-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service toolsAdded=2
time=2025-12-19T16:47:49.726-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/pool/pool.go:364 msg="Closing old entry" name=weather-service
time=2025-12-19T16:47:49.727-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.727-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.727-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service toolsAdded=2
=== RUN   TestGRPCUpstream_Register_WithMockServer/correct_input_schema_generation
time=2025-12-19T16:47:49.729-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.729-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.729-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service toolsAdded=2
=== RUN   TestGRPCUpstream_Register_WithMockServer/auto_discovery
time=2025-12-19T16:47:49.731-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.731-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.731-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-auto toolsAdded=2
--- PASS: TestGRPCUpstream_Register_WithMockServer (0.01s)
    --- PASS: TestGRPCUpstream_Register_WithMockServer/successful_registration_with_reflection_and_cache_hit (0.00s)
    --- PASS: TestGRPCUpstream_Register_WithMockServer/correct_input_schema_generation (0.00s)
    --- PASS: TestGRPCUpstream_Register_WithMockServer/auto_discovery (0.00s)
=== RUN   TestFindMethodDescriptor
=== RUN   TestFindMethodDescriptor/invalid_full_method_name
=== RUN   TestFindMethodDescriptor/service_not_found
=== RUN   TestFindMethodDescriptor/descriptor_is_not_a_service
=== RUN   TestFindMethodDescriptor/method_not_found
=== RUN   TestFindMethodDescriptor/valid_full_method_name
=== RUN   TestFindMethodDescriptor/valid_full_method_name_with_leading_slash
--- PASS: TestFindMethodDescriptor (0.00s)
    --- PASS: TestFindMethodDescriptor/invalid_full_method_name (0.00s)
    --- PASS: TestFindMethodDescriptor/service_not_found (0.00s)
    --- PASS: TestFindMethodDescriptor/descriptor_is_not_a_service (0.00s)
    --- PASS: TestFindMethodDescriptor/method_not_found (0.00s)
    --- PASS: TestFindMethodDescriptor/valid_full_method_name (0.00s)
    --- PASS: TestFindMethodDescriptor/valid_full_method_name_with_leading_slash (0.00s)
=== RUN   TestGRPCUpstream_Register_UseReflection_WithPolicy
time=2025-12-19T16:47:49.734-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.734-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:235 msg="Skipping non-exported tool (annotation)" toolName=ServerReflectionInfo
time=2025-12-19T16:47:49.735-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:457 msg="Skipping disabled tool (config)" toolName=grpc_reflection_v1alpha_ServerReflection_ServerReflectionInfo
time=2025-12-19T16:47:49.735-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-policy toolsAdded=1
--- PASS: TestGRPCUpstream_Register_UseReflection_WithPolicy (0.00s)
=== RUN   TestGRPCUpstream_Register_DynamicResources
time=2025-12-19T16:47:49.736-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.737-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.737-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:469 msg="Call definition not found for tool" call_id=weather_call tool_name=GetWeather
time=2025-12-19T16:47:49.737-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-dynamic toolsAdded=2
--- PASS: TestGRPCUpstream_Register_DynamicResources (0.00s)
=== RUN   TestGRPCUpstream_Register_DuplicateTool
time=2025-12-19T16:47:49.739-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.739-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-dup toolsAdded=1
--- PASS: TestGRPCUpstream_Register_DuplicateTool (0.00s)
=== RUN   TestGRPCUpstream_Register_DuplicateTool_Config
time=2025-12-19T16:47:49.740-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:476 msg="Failed to find method descriptor, skipping tool." tool_name=GetWeather method_fqn=.test.TestService/GetWeather error="could not find descriptor for service '.test.TestService': proto:\u00a0not found"
time=2025-12-19T16:47:49.740-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-dup-config toolsAdded=0
--- PASS: TestGRPCUpstream_Register_DuplicateTool_Config (0.00s)
=== RUN   TestGRPCUpstream_Register_ExportPolicy_Config
time=2025-12-19T16:47:49.741-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:235 msg="Skipping non-exported tool (annotation)" toolName=GetWeather
time=2025-12-19T16:47:49.741-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:463 msg="Skipping non-exported tool (config)" toolName=GetWeather
time=2025-12-19T16:47:49.741-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-export-config toolsAdded=0
--- PASS: TestGRPCUpstream_Register_ExportPolicy_Config (0.00s)
=== RUN   TestGRPCUpstream_Register_AddToolError
time=2025-12-19T16:47:49.742-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:324 msg="Failed to add gRPC tool" tool_name=GetWeather error="injection error"
time=2025-12-19T16:47:49.742-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:324 msg="Failed to add gRPC tool" tool_name=ServerReflectionInfo error="injection error"
time=2025-12-19T16:47:49.743-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-error toolsAdded=0
--- PASS: TestGRPCUpstream_Register_AddToolError (0.00s)
=== RUN   TestGRPCUpstream_Register_DynamicResource_ToolNotFound
time=2025-12-19T16:47:49.744-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.745-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.745-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:353 msg="tool not found for dynamic resource" call_id=non_existent_call
time=2025-12-19T16:47:49.745-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-dynamic-fail toolsAdded=2
--- PASS: TestGRPCUpstream_Register_DynamicResource_ToolNotFound (0.00s)
=== RUN   TestGRPCUpstream_Register_FromConfig
    grpc_test.go:822: 
        	Error Trace:	/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc_test.go:822
        	Error:      	Received unexpected error:
        	            	failed to parse proto definitions for weather-service-config: failed to write proto file: failed to read proto file from path ../../../proto/examples/weather/v1/weather.proto: open ../../../proto/examples/weather/v1/weather.proto: no such file or directory
        	Test:       	TestGRPCUpstream_Register_FromConfig
--- FAIL: TestGRPCUpstream_Register_FromConfig (0.00s)
=== RUN   TestGRPCUpstream_Register_WithPrompts
time=2025-12-19T16:47:49.747-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.747-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.748-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:549 msg="Registered prompt" prompt_name=weather-service-prompts.weather_prompt is_reload=false
time=2025-12-19T16:47:49.748-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-prompts toolsAdded=2
--- PASS: TestGRPCUpstream_Register_WithPrompts (0.00s)
=== RUN   TestGRPCUpstream_Register_Prompts_Invalid
time=2025-12-19T16:47:49.751-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetWeather is_reload=false
time=2025-12-19T16:47:49.751-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.751-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:536 msg="Skipping prompt with missing name"
time=2025-12-19T16:47:49.751-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-invalid-prompts toolsAdded=2
--- PASS: TestGRPCUpstream_Register_Prompts_Invalid (0.00s)
=== RUN   TestGRPCUpstream_Register_AutoDiscover
time=2025-12-19T16:47:49.753-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=GetData is_reload=false
time=2025-12-19T16:47:49.753-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=test-service-autodiscover toolsAdded=1
--- PASS: TestGRPCUpstream_Register_AutoDiscover (0.00s)
=== RUN   TestGRPCUpstream_Register_FromConfig_MethodNotFound
time=2025-12-19T16:47:49.753-08:00 level=ERROR source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:476 msg="Failed to find method descriptor, skipping tool." tool_name=GetWeather method_fqn=.test.TestService/NonExistentMethod error="could not find descriptor for service '.test.TestService': proto:\u00a0not found"
time=2025-12-19T16:47:49.753-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-method-fail toolsAdded=0
--- PASS: TestGRPCUpstream_Register_FromConfig_MethodNotFound (0.00s)
=== RUN   TestGRPCUpstream_Register_DisabledTool_Reflection
time=2025-12-19T16:47:49.755-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:331 msg="Registered gRPC tool" tool_id=ServerReflectionInfo is_reload=false
time=2025-12-19T16:47:49.755-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:229 msg="Skipping disabled tool (annotation)" toolName=GetWeather
time=2025-12-19T16:47:49.755-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:457 msg="Skipping disabled tool (config)" toolName=GetWeather
time=2025-12-19T16:47:49.755-08:00 level=INFO source=/usr/local/google/home/kxw/core/server/pkg/upstream/grpc/grpc.go:184 msg="Registered gRPC service" serviceID=weather-service-disabled toolsAdded=1
--- PASS: TestGRPCUpstream_Register_DisabledTool_Reflection (0.00s)
FAIL
FAIL	github.com/mcpany/core/pkg/upstream/grpc	10.099s
FAIL
