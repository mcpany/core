# Copyright 2025 Author(s) of MCP Any
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

FROM golang:1.24-bookworm

# Install system dependencies
# Install system dependencies and Node.js 20
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    make \
    unzip \
    sudo \
    python3 \
    python3-pip \
    python3-venv \
    docker.io \
    gnupg \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_24.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update && apt-get install -y nodejs \
    # Playwright dependencies
    libnspr4 \
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libxkbcommon0 \
    libatspi2.0-0 \
    libxdamage1 \
    libcairo2 \
    libpango-1.0-0 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Copy root modules
COPY go.mod go.sum ./

# Copy server files
COPY server/Makefile server/go.mod server/go.sum server/requirements.txt ./server/
COPY server/tools/ ./server/tools/
COPY proto/ ./proto/

WORKDIR /workspace/server

# Run make prepare to install tools
ENV TOOL_INSTALL_DIR=/workspace/server/tools
# Install pre-commit globally to be available in CI mode
RUN pip3 install --break-system-packages pre-commit fastmcp
# Set CI=true to skip venv setup in Makefile
ENV CI=true
RUN mkdir -p /tools && make prepare && chmod -R 777 /tools

# Create a non-root user to match the host user
# We use a fixed fallback UID/GID or passed build args potentially?
# Actually, we can just create a home directory that is writable.
# But for "user: ${UID}:${GID}" to work nicely, it's better if the user exists in /etc/passwd if we need shell access,
# although Docker runs fine with arbitrary UIDs.
# However, for "HOME=/home/user" to be valid and writable, we should ensure permissions.

# Since we map ~/.cache to /home/user/.cache, we just need to make sure /home/user exists.
ARG UID=1000
ARG GID=1000
ARG DOCKER_GID=999

RUN groupadd -g ${GID} user || true && \
    groupadd -g ${DOCKER_GID} docker_host_group || true && \
    useradd -u ${UID} -g ${GID} -G ${DOCKER_GID} -m -s /bin/bash user && \
    echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Add installed tools to PATH
ENV PATH="/workspace/server/tools:${PATH}"
ENV GOPATH="/workspace/server/tools/go"
ENV PATH="$GOPATH/bin:$PATH"

CMD ["/bin/bash"]
