services:
  mcpany-server:
    build:
      context: .
      dockerfile: server/docker/Dockerfile.server
    ports:
      - "50050:50050"
      - "50051:50051"
    volumes:
      - ./server/audit_config.yaml:/etc/mcpany/config.yaml
    environment:
      - REDIS_ADDRESS=redis:6379
      - MCPANY_ENABLE_FILE_CONFIG=true
    command: ["run", "--config-path", "/etc/mcpany/config.yaml"]
    depends_on:
      - redis
    networks:
      - mcpany-net
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "http://localhost:50050/healthz"]
      interval: 5s
      timeout: 2s
      retries: 5

  redis:
    image: mirror.gcr.io/library/redis:latest
    ports:
      - "6379:6379"
    networks:
      - mcpany-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:50050
      - BACKEND_URL=http://mcpany-server:50050
    depends_on:
      mcpany-server:
        condition: service_healthy
    networks:
      - mcpany-net

networks:
  mcpany-net:
    driver: bridge
