# Copyright 2025 Author(s) of MCP Any
# SPDX-License-Identifier: Apache-2.0

# This is the PRODUCTION-ready Docker Compose file for MCP Any.
# It includes the core server, configuration for Redis (for message bus),
# and Prometheus (for metrics).
#
# For an example with an echo server, see examples/docker-compose-demo/

services:
  # The MCP Any server itself.
  mcpany-server:
    image: mcpany/server:latest
    ports:
      # Exposes the JSON-RPC port (for tool calls) to the host.
      - "50055:50050"
      # Exposes the gRPC registration port to the host.
      - "50056:50051"
    volumes:
      # Mounts the production config file.
      - ./server/docker/config.production.yaml:/etc/mcpany/config.yaml
    environment:
      # Allows overriding Redis address if needed (defaults to redis:6379 in config.production.yaml)
      - REDIS_ADDRESS=redis:6379
    entrypoint:
      # Tells the server to load the configuration from the mounted path.
      - "/app/server"
      - "run"
      - "--config-path"
      - "/etc/mcpany/config.yaml"
      - "--metrics-listen-address"
      - ":9090"
    healthcheck:
      test:
        ["CMD", "curl", "--fail", "--silent", "http://localhost:50050/healthz"]
      interval: 5s
      timeout: 2s
      retries: 5
    depends_on:
      redis:
        condition: service_started
    networks:
      - mcpany-net

  redis:
    image: public.ecr.aws/docker/library/redis:latest
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - mcpany-net

  prometheus:
    image: public.ecr.aws/prometheus/prometheus:latest
    volumes:
      - ./server/docker/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9099:9090"
    networks:
      - mcpany-net

  ui:
    image: mcpany/ui:latest
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:50055
      - BACKEND_URL=http://mcpany-server:50050
    depends_on:
      mcpany-server:
        condition: service_started
    networks:
      - mcpany-net


networks:
  mcpany-net:
    driver: bridge
